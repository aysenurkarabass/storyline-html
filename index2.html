<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tam Gölge Laboratuvarı - Eğlenceli Deney</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- 5. Sınıf - Soft & Renkli Palet --- */
            
            /* Genel Arka Plan: Göz yormayan, açık pastel mavi */
            --bg-body: #E3F2FD; 
            
            /* Kartlar ve Paneller: Beyaz ve temiz */
            --bg-card: #FFFFFF;
            
            /* Sahne: Deney için koyu ama korkutucu olmayan "Uzay Mavisi" */
            --bg-stage-gradient-start: #3E51B5; /* İndigo */
            --bg-stage-gradient-end: #1A237E;   /* Derin Lacivert */

            /* Ana Renk (Başlıklar, Çizgiler): Dost canlısı Mavi */
            --primary: #4FC3F7; /* Açık Mavi */
            --primary-text: #0277BD; /* Koyu Mavi (Yazılar için) */
            
            /* Butonlar ve Vurgular */
            --btn-color: #29B6F6;
            --accent: #FFCA28; /* Amber (Güneş Sarısı) */
            
            /* Başarı/Sonuç: Yumuşak Yeşil */
            --success: #66BB6A;
            
            /* Metin Renkleri (Açık zemin üzerinde koyu yazı) */
            --text-main: #455A64; /* Koyu Gri-Mavi */
            --text-muted: #78909C;
            --text-light: #FFFFFF; /* Koyu zeminler için beyaz */
            
            /* Düzen Değişkenleri */
            --axis-y: 250px;
            
            /* Katman Yönetimi */
            --z-beam: 1;
            --z-screen-obj: 5;
            --z-drag-item: 10;
            --z-evaluation: 50;
            --z-overlay: 100;
            --z-logo: 101;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg-body);
            /* Arka plana hafif puantiye deseni ekleyerek eğlence katalım */
            background-image: radial-gradient(#B3E5FC 2px, transparent 2px);
            background-size: 30px 30px;
            color: var(--text-main);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- LOGO STİLİ --- */
        .site-logo {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            height: auto;
            max-height: 85%;
            width: auto;
            max-width: 110px;
            z-index: 20;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
            pointer-events: none;
        }

        .intro-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            padding: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            box-sizing: border-box;
            z-index: 102;
            pointer-events: none;
        }

        .intro-logo {
            width: 140px;
            height: auto;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        /* Giriş Ekranı */
        #intro-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            /* Buzlu cam efekti ve yarı saydam beyaz arka plan */
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            z-index: var(--z-overlay);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .intro-card {
            background: #FFFFFF;
            padding: 50px;
            border-radius: 40px;
            /* Renkli, kalın kenarlık */
            border: 6px solid var(--primary);
            max-width: 800px;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 20px 50px rgba(79, 195, 247, 0.3);
        }

        /* Buton Stilleri - Şeker gibi */
        .btn {
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }
        .btn:focus-visible {
            outline: 4px solid var(--accent);
            outline-offset: 2px;
        }
        .btn:active { transform: scale(0.95) !important; }

        .btn-start {
            background: #FF7043; /* Canlı Mercan Rengi */
            color: white;
            padding: 18px 60px;
            font-size: 30px;
            font-weight: 600;
            border-radius: 50px;
            margin-top: 30px;
            box-shadow: 0 8px 0 #D84315; /* 3D efekt */
            margin-bottom: 8px;
        }
        .btn-start:hover { 
            background: #FF8A65; 
            transform: translateY(-4px); 
            box-shadow: 0 12px 0 #D84315;
        }
        .btn-start:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #D84315;
        }

        .warning-box {
            background: #FFF8E1; /* Çok açık sarı */
            border-left: 8px solid #FFCA28;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .warning-box .warning-icon {
            flex-shrink: 0;
            color: #FFB300;
            width: 32px;
            height: 32px;
        }
        .warning-box p {
            margin: 0;
            font-size: 18px;
            line-height: 1.5;
            color: #795548;
            font-weight: 500;
            text-align: left;
        }

        /* Ana Sahne Yapısı */
        #main-container {
            width: 100%;
            height: 100vh;
            margin: 0;
            position: relative;
            display: none;
            flex-direction: column;
            gap: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* HEADER */
        #header-section {
            background: #FFFFFF;
            padding: 1.5vh 0;
            flex-shrink: 0;
            height: auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            z-index: 20;
            border-bottom: 5px solid #81D4FA; /* Alt çizgi */
        }

        #step-title {
            color: var(--primary-text);
            font-size: 3.5vh;
            font-weight: 600;
            margin: 0;
            line-height: 1.2;
            text-align: center;
            padding: 0 120px;
        }

        #content-section {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
            align-items: stretch;
            overflow: hidden;
            min-height: 0;
        }

        /* SONUÇ EKRANI */
        #evaluation-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            /* Sonuç ekranı arka planı: Yarı saydam koyu mavi */
            background: rgba(26, 35, 126, 0.95);
            z-index: var(--z-evaluation);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
            overflow-y: auto;
            border-radius: 25px; /* Sahne ile uyumlu köşe */
        }

        #evaluation-screen.show { display: flex; }

        /* Scrollbar */
        body::-webkit-scrollbar { width: 12px; }
        body::-webkit-scrollbar-track { background: #ECEFF1; }
        body::-webkit-scrollbar-thumb { background: #90A4AE; border-radius: 10px; border: 2px solid #ECEFF1; }

        .result-table {
            width: 100%;
            max-width: 800px;
            border-collapse: separate;
            border-spacing: 0;
            background: #FFFFFF; /* Tablo içi beyaz */
            border-radius: 25px;
            overflow: hidden;
            margin: 30px 0;
            font-size: 18px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            border: 4px solid #FFF;
        }
        .result-table th, .result-table td {
            padding: 18px 25px;
            border-bottom: 2px solid #F0F0F0;
            text-align: left;
            color: var(--text-main);
        }
        .result-table th { 
            background: #29B6F6; 
            color: white; 
            font-weight: 600;
            border: none;
        }
        .result-table tr:last-child td { border-bottom: none; }

        /* Sol Panel (Kontrol ve Bilgi) */
        #step-panel {
            width: 300px;
            min-width: 280px;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .instruction-box {
            background: #FFFFFF;
            padding: 25px;
            border-radius: 25px;
            border: 3px solid #E1F5FE;
            /* Sol tarafı renkli çizgiyle vurgula */
            border-left: 10px solid var(--btn-color);
            font-size: 18px; /* Küçültüldü (Eski: 20px) */
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(179, 229, 252, 0.4);
            color: var(--text-main);
        }

        .result-box {
            background: #FFFFFF;
            padding: 20px;
            border-radius: 25px;
            border: 4px dashed #FFB74D; /* Turuncu kesik çizgi */
            color: #F57C00; /* Koyu Turuncu Yazı */
            font-weight: 600;
            font-size: 20px;
            margin-top: auto;
            line-height: 1.4;
            box-shadow: 0 5px 15px rgba(255, 224, 178, 0.5);
        }

        .result-box-title {
            font-size: 14px;
            color: #90A4AE;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .nav-buttons {
            margin-top: auto;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-nav {
            background: #ECEFF1;
            color: #546E7A;
            padding: 14px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
            font-family: 'Fredoka', sans-serif;
            text-align: center;
            border: 2px solid transparent;
        }
        .btn-nav:hover { 
            background: #CFD8DC; 
            transform: scale(1.02);
        }
        .btn-nav.active { 
            background: var(--btn-color); 
            color: white; 
            border-color: transparent;
            box-shadow: 0 6px 15px rgba(41, 182, 246, 0.3);
        }
        .btn-nav.finish { 
            background: var(--success); 
            color: white;
            box-shadow: 0 4px 0 #43A047;
            margin-bottom: 4px;
        }
        .btn-nav.finish:hover { background: #4CAF50; transform: translateY(-2px); box-shadow: 0 6px 0 #43A047; }
        .btn-nav.finish:active { transform: translateY(2px); box-shadow: 0 2px 0 #43A047; }

        /* Sağ Panel (Deney Sahnesi) */
        #stage {
            flex: 1;
            height: 100%;
            /* Uzay/Laboratuvar hissi için derin mavi gradyan */
            background: radial-gradient(circle at bottom, var(--bg-stage-gradient-start) 0%, var(--bg-stage-gradient-end) 100%);
            border: 8px solid #FFFFFF;
            border-radius: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(62, 81, 181, 0.2);
            perspective: 1000px;
            min-height: 0;
        }

        /* Simülasyon Elemanları */
        #light-beam-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: var(--z-beam); }
        
        .draggable { 
            position: absolute; 
            cursor: grab; 
            z-index: var(--z-drag-item); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            outline: none; 
            transition: transform 0.1s;
        }
        .draggable:active { cursor: grabbing; transform: scale(1.1); }
        .draggable:focus-visible { filter: drop-shadow(0 0 15px var(--accent)); }
        
        .active-step { 
            /* Aktif öğe etrafında animasyonlu halka */
            animation: bounce-highlight 2s infinite;
        }

        @keyframes bounce-highlight {
            0%, 100% { filter: drop-shadow(0 0 5px #FFF176); transform: translateY(0); }
            50% { filter: drop-shadow(0 0 20px #FFEB3B); transform: translateY(-3px); }
        }

        #flashlight { height: 70px; top: calc(var(--axis-y) - 35px); left: 80px; }
        .f-body { width: 65px; height: 36px; background: #78909C; border-radius: 10px 0 0 10px; border: 2px solid #546E7A; }
        .f-head { width: 35px; height: 70px; background: #455A64; border-radius: 8px; border-right: 8px solid #FFEB3B; box-shadow: 0 0 15px #FFEB3B; }

        #object {
            width: 70px; height: 70px;
            /* Top daha parlak ve 3 boyutlu */
            background: radial-gradient(circle at 35% 35%, #69F0AE, #00C853);
            border-radius: 50%;
            border: 3px solid #B9F6CA;
            top: calc(var(--axis-y) - 35px); left: 450px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #screen-container {
            position: absolute; top: 50px; left: 800px; width: 140px; height: 400px; z-index: var(--z-screen-obj);
            perspective: 800px;
        }
        #screen-surface {
            width: 100%; height: 100%; background: #F5F5F5; border: 8px solid #37474F;
            border-radius: 12px; position: relative; overflow: hidden;
            transform: rotateY(-20deg);
            transform-origin: center right;
            box-shadow: -15px 15px 30px rgba(0,0,0,0.3);
        }

        #shadow { 
            position: absolute;
            background: rgba(0,0,0,0.85); 
            border-radius: 50%; 
            filter: blur(5px);
            transition: width 0.1s, height 0.1s, left 0.1s, top 0.1s;
        }

        .label {
            position: absolute; bottom: -55px; left: 50%; transform: translateX(-50%);
            font-size: 15px; font-weight: 700; color: #FFFFFF; text-transform: uppercase;
            /* Etiketler daha belirgin */
            background: #546E7A; padding: 6px 14px; border-radius: 20px; white-space: nowrap;
            pointer-events: none;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        #instruction-text {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            font-size: 2.2vh; /* Küçültüldü (Eski: 2.8vh) */
            color: var(--text-main);
        }

        /* Utility */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- GİRİŞ EKRANI -->
    <section id="intro-overlay">
        <!-- LOGO HEADER İÇİNDE -->
        <div class="intro-header">
            <img src="e12_logo_kare (1).png" alt="Logo" class="intro-logo">
        </div>

        <div class="intro-card">
            <h1 class="text-primary mb-3" style="color: var(--primary-text); margin-bottom: 25px; font-size: 42px;">Tam Gölge Laboratuvarına Hoş Geldin!</h1>
            <p style="font-size: 22px; line-height: 1.6; color: var(--text-main);">
                <b>Deneyin Amacı:</b> Işık kaynağı, opak cisim ve ekran arasındaki mesafelerin, oluşan tam gölgenin boyutuna etkisini adım adım keşfedelim.
            </p>
            <p style="opacity: 0.8; font-size: 20px; margin-top: 15px; color: var(--text-muted);">Hazırsan, gözlem yapmaya başlayalım!</p>
            
            <div class="warning-box">
                <svg class="warning-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 9V11M12 15H12.01M5.07183 19H18.9282C20.4678 19 21.4301 17.3333 20.6603 16L13.7321 4C12.9623 2.66667 11.0377 2.66667 10.2679 4L3.33975 16C2.56995 17.3333 3.53223 19 5.07183 19Z" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p>En iyi deneyim için bu simülasyonu geniş ekranlı bir bilgisayarda açmanı öneririz.</p>
            </div>

            <button id="btn-start-exp" class="btn btn-start">Hadi Başlayalım!</button>
        </div>
    </section>

    <!-- DENEY ALANI -->
    <main id="main-container">
        <!-- BAŞLIK -->
        <header id="header-section">
            <h2 id="step-title">Adım 1: Işık Kaynağı Hareketinin Gölgeye Etkisi</h2>
            <!-- LOGO -->
            <img src="e12_logo_kare (1).png" alt="Logo" class="site-logo">
        </header>

        <!-- İÇERİK -->
        <section id="content-section">
            <aside id="step-panel">
                <div class="instruction-box">
                    <div id="instruction-text">Yükleniyor...</div>
                    <nav class="nav-buttons" aria-label="Adım Navigasyonu">
                        <button id="btn1" class="btn btn-nav active" data-step="1">1. Adım</button>
                        <button id="btn2" class="btn btn-nav" data-step="2">2. Adım</button>
                        <button id="btn3" class="btn btn-nav" data-step="3">3. Adım</button>
                        <button id="btn4" class="btn btn-nav finish" data-step="4">SONUÇ</button>
                    </nav>
                </div>
                <div class="result-box">
                    <div class="result-box-title">BİLİMSEL SONUÇ:</div>
                    <div id="result-text">Harekete geçerek gözlem yap!</div>
                </div>
            </aside>
        
            <div id="stage">
                <!-- SONUÇ EKRANI PANELİ -->
                <section id="evaluation-screen">
                    <h1 style="color: #4FC3F7; margin: 0; font-size: 36px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Deney Sonuç Raporu</h1>
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Değişken</th>
                                <th>Yapılan İşlem</th>
                                <th>Gölge Boyutu Değişimi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Işık Kaynağı</td>
                                <td>Cisme Yaklaşırsa</td>
                                <td style="color: #2E7D32; font-weight: 700;">Büyür ▲</td>
                            </tr>
                            <tr>
                                <td>Cisim</td>
                                <td>Işık Kaynağına Yaklaşırsa</td>
                                <td style="color: #2E7D32; font-weight: 700;">Büyür ▲</td>
                            </tr>
                            <tr>
                                <td>Ekran (Perde)</td>
                                <td>Cisimden Uzaklaşırsa</td>
                                <td style="color: #2E7D32; font-weight: 700;">Büyür ▲</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="text-align: center; max-width: 700px; font-size: 20px; color: #E3F2FD; line-height: 1.6;">Işık doğrusal yayıldığı için engelin (cisim) ışığa olan uzaklığı veya ekranın konumu gölgenin boyutunu doğrudan etkiler.</p>
                    <button id="btn-restart" class="btn btn-start" style="padding: 12px 40px; font-size: 20px; margin-top: 25px; background: #66BB6A; box-shadow: 0 6px 0 #2E7D32;">Deneyi Tekrarla</button>
                </section>

                <svg id="light-beam-svg">
                    <defs>
                        <linearGradient id="beamGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <!-- Işık hüzmesi rengi sarı, yumuşak geçişli -->
                            <stop offset="0%" style="stop-color:rgba(255, 235, 59, 0.4)" />
                            <stop offset="100%" style="stop-color:rgba(255, 235, 59, 0)" />
                        </linearGradient>
                    </defs>
                    <polygon id="beam-path" fill="url(#beamGrad)" />
                </svg>

                <div id="flashlight" class="draggable" tabindex="0" role="slider" aria-label="Işık Kaynağı" aria-valuemin="0" aria-valuemax="100">
                    <div class="f-body"></div><div class="f-head"></div>
                    <span class="label">Işık Kaynağı</span>
                </div>

                <div id="object" class="draggable" tabindex="0" role="slider" aria-label="Opak Cisim">
                    <span class="label">Opak Cisim</span>
                </div>

                <div id="screen-container" class="draggable" tabindex="0" role="slider" aria-label="Ekran">
                    <div id="screen-surface">
                        <div id="shadow"></div>
                    </div>
                    <span class="label">Ekran (Perde)</span>
                </div>
            </div>
        </section>
    </main>

    <script>
        // DOM Elementleri
        const ui = {
            introOverlay: document.getElementById('intro-overlay'),
            mainContainer: document.getElementById('main-container'),
            stage: document.getElementById('stage'),
            flashlight: document.getElementById('flashlight'),
            object: document.getElementById('object'),
            screen: document.getElementById('screen-container'),
            shadow: document.getElementById('shadow'),
            beamPath: document.getElementById('beam-path'),
            evaluationScreen: document.getElementById('evaluation-screen'),
            stepTitle: document.getElementById('step-title'),
            instructionText: document.getElementById('instruction-text'),
            resultText: document.getElementById('result-text'),
            navButtons: document.querySelectorAll('.btn-nav'),
            btnStart: document.getElementById('btn-start-exp'),
            btnRestart: document.getElementById('btn-restart')
        };
        
        let currentStep = 1;
        let isDragging = false;
        let activeEl = null;

        // yüzde tabanlı başlangıç pozisyonları (0..1 arası)
        let state = { lx: 0.08, ox: 0.45, sx: 0.8 };

        const steps = {
            1: {
                title: "Adım 1: Işık Kaynağı Hareketinin Gölgeye Etkisi",
                instruction: "Sadece ışık kaynağını ileri ve geri hareket ettirerek gölgedeki değişimi inceleyelim. (Mouse ile sürükle veya Klavye ok tuşlarını kullan)",
                result: "Işık kaynağı cisme yaklaştığında ışınlar daha geniş açıyla yayılır ve gölge büyür. Işık kaynağı uzaklaştığında ise gölge küçülür.",
                target: ui.flashlight
            },
            2: {
                title: "Adım 2: Cisim Hareketinin Gölgeye Etkisi",
                instruction: "Sadece yeşil cismi ışık kaynağına yaklaştırıp uzaklaştırarak gölgeyi gözlemleyelim.",
                result: "Cisim ışık kaynağına yaklaştığında daha fazla ışığı engeller ve ekrandaki gölge büyür. Cisim ekrana yaklaştığında ise gölge küçülür.",
                target: ui.object
            },
            3: {
                title: "Adım 3: Ekran (Perde) Hareketinin Gölgeye Etkisi",
                instruction: "Sadece beyaz ekranı (perdeyi) cisme yaklaştırıp uzaklaştırarak gölge boyutunu gözlemleyelim.",
                result: "Ekran cisimden uzaklaştıkça ışık ışınlarının yayıldığı alan genişler ve gölge büyür. Perde cisme yaklaştığında gölge küçülür.",
                target: ui.screen
            },
            4: {
                title: "Deney Tamamlandı!",
                instruction: "Harika iş çıkardın! Şimdi deney sonuçlarını aşağıdaki sonuç kısmından inceleyebilirsin.",
                result: "Deney başarıyla tamamlandı.",
                target: null
            }
        };

        // --- Event Listeners ---
        
        ui.btnStart.addEventListener('click', startExperiment);
        ui.btnRestart.addEventListener('click', () => location.reload());

        ui.navButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const step = parseInt(e.target.dataset.step);
                setStep(step);
            });
        });

        window.addEventListener('mousedown', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('touchstart', onStart, {passive: false});
        window.addEventListener('touchmove', onMove, {passive: false});
        window.addEventListener('touchend', onEnd);
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('resize', updateScene);
        window.addEventListener('load', updateScene);

        // --- Fonksiyonlar ---

        function startExperiment() {
            ui.introOverlay.style.display = 'none';
            ui.mainContainer.style.display = 'flex';
            setStep(1);
            updateScene();
        }

        function setStep(n) {
            currentStep = n;
            ui.navButtons.forEach(b => b.classList.remove('active'));
            
            const activeBtn = document.querySelector(`.btn-nav[data-step="${n}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            ui.stepTitle.innerText = steps[n].title;
            ui.instructionText.innerHTML = steps[n].instruction;
            ui.resultText.innerText = steps[n].result;

            removeHighlights();

            if (n === 4) {
                ui.evaluationScreen.classList.add('show');
            } else {
                ui.evaluationScreen.classList.remove('show');
                if(steps[n].target) {
                    steps[n].target.classList.add('active-step');
                    steps[n].target.focus();
                }
            }
            
            updateScene();
        }

        function removeHighlights() {
            [ui.flashlight, ui.object, ui.screen].forEach(el => el.classList.remove('active-step'));
        }

        function updateScene() {
            const rect = ui.stage.getBoundingClientRect();
            const stageW = rect.width;
            const stageH = rect.height;
            const centerY = stageH / 2;

            const screenW = Math.max(80, Math.min(160, Math.round(stageW * 0.14)));
            const screenH = Math.max(100, Math.min(stageH * 0.9, Math.round(stageH * 0.6)));
            ui.screen.style.width = screenW + 'px';
            ui.screen.style.height = screenH + 'px';

            const fW = ui.flashlight.offsetWidth || 60;
            const fH = ui.flashlight.offsetHeight || 60;
            const oW = ui.object.offsetWidth || 60;
            const oH = ui.object.offsetHeight || 60;
            const sW = ui.screen.offsetWidth || screenW;
            const sH = ui.screen.offsetHeight || screenH;

            const lxPx = Math.round(state.lx * stageW);
            const oxPx = Math.round(state.ox * stageW);
            const sxPx = Math.round(state.sx * stageW);

            ui.flashlight.style.left = (lxPx - fW/2) + "px";
            ui.flashlight.style.top = (centerY - fH/2) + "px";
            ui.object.style.left = (oxPx - oW/2) + "px";
            ui.object.style.top = (centerY - oH/2) + "px";
            ui.screen.style.left = (sxPx - sW/2) + "px";
            ui.screen.style.top = (centerY - sH/2) + "px";

            const fX = lxPx;
            const oX = oxPx;
            const sX = sxPx;
            const objR = Math.max(10, oW/2);

            const distLO = Math.max(30, oX - fX);
            const distLS = Math.max(distLO + 10, sX - fX);

            let shadowH = (objR * 2 * distLS) / distLO;
            shadowH = Math.min(shadowH, sH - 20); 
            ui.shadow.style.height = shadowH + "px";
            
            const shadowW = Math.max(20, shadowH * 0.75);
            const constrainedShadowW = Math.min(shadowW, sW - 10);
            const constrainedShadowH = Math.min(shadowH, sH - 10);
            
            const shadowLeft = (sW - constrainedShadowW) / 2;
            const shadowTop = (sH - constrainedShadowH) / 2;
            
            ui.shadow.style.left = shadowLeft + "px";
            ui.shadow.style.top = shadowTop + "px";
            ui.shadow.style.width = constrainedShadowW + "px";
            ui.shadow.style.height = constrainedShadowH + "px";

            const sTopY = centerY - (shadowH / 2);
            const sBottomY = centerY + (shadowH / 2);
            ui.beamPath.setAttribute("points", `${fX},${centerY} ${sX},${sTopY} ${sX},${sBottomY}`);
        }

        function getClientXFromEvent(e) {
            if (e.touches && e.touches.length) return e.touches[0].clientX;
            return e.clientX !== undefined ? e.clientX : (e.changedTouches && e.changedTouches[0] && e.changedTouches[0].clientX) || 0;
        }

        function onStart(e) {
            if (currentStep === 4) return;
            const el = e.target.closest('.draggable');
            if (!el) return;
            
            const stepTarget = steps[currentStep].target;
            if (stepTarget && el !== stepTarget) return;

            if(e.type === 'touchstart') e.preventDefault();
            
            isDragging = true;
            activeEl = el;
            activeEl.focus();
        }

        function onMove(e) {
            if (!isDragging || !activeEl) return;
            if(e.type === 'touchmove') e.preventDefault();
            
            const rect = ui.stage.getBoundingClientRect();
            const clientX = getClientXFromEvent(e);
            let x = clientX - rect.left;
            
            let pct = x / rect.width;
            updateElementPosition(activeEl, pct);
        }

        function onEnd() { isDragging = false; activeEl = null; }

        function onKeyDown(e) {
            if (currentStep === 4) return;
            const activeElement = document.activeElement;
            
            if (activeElement.classList.contains('draggable') && activeElement === steps[currentStep].target) {
                let currentPct = 0;
                if (activeElement === ui.flashlight) currentPct = state.lx;
                else if (activeElement === ui.object) currentPct = state.ox;
                else if (activeElement === ui.screen) currentPct = state.sx;

                if (e.key === 'ArrowLeft') {
                    updateElementPosition(activeElement, currentPct - 0.01);
                } else if (e.key === 'ArrowRight') {
                    updateElementPosition(activeElement, currentPct + 0.01);
                }
            }
        }

        function updateElementPosition(element, targetPct) {
            const rect = ui.stage.getBoundingClientRect();
            targetPct = Math.max(0.02, Math.min(0.98, targetPct));
            const minGapPx = 60;
            const minGapPct = minGapPx / rect.width;

            if (element === ui.flashlight) {
                state.lx = Math.min(targetPct, state.ox - minGapPct);
                state.lx = Math.max(0.02, state.lx);
            } else if (element === ui.object) {
                state.ox = Math.max(state.lx + minGapPct, Math.min(targetPct, state.sx - minGapPct));
            } else if (element === ui.screen) {
                state.sx = Math.max(state.ox + minGapPct, Math.min(targetPct, 0.98));
            }
            updateScene();
        }
    </script>
</body>
</html>